<!-- Notification Toast -->
<div *ngIf="notification() as notif" class="fixed right-8 top-24 z-50 max-w-sm">
    <div class="flex items-center rounded-lg border-l-4 p-4 shadow-xl"
        [ngClass]="{'border-green-500 bg-green-50': notif.type === 'success', 'border-red-500 bg-red-50': notif.type === 'error'}">
        <svg *ngIf="notif.type === 'success'" class="h-6 w-6 flex-shrink-0 text-green-600" fill="none"
            viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
            <path stroke-linecap="round" stroke-linejoin="round"
                d="M9 12.75 11.25 15 15 9.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
        </svg>
        <svg *ngIf="notif.type === 'error'" class="h-6 w-6 flex-shrink-0 text-red-600" fill="none" viewBox="0 0 24 24"
            stroke="currentColor" stroke-width="1.5">
            <path stroke-linecap="round" stroke-linejoin="round"
                d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126ZM12 15.75h.007v.008H12v-.008Z" />
        </svg>
        <div class="ml-3"
            [ngClass]="{'text-green-800': notif.type === 'success', 'text-red-800': notif.type === 'error'}">
            <h3 class="font-bold">{{ notif.type === 'success' ? 'Success' : 'Error' }}</h3>
            <p class="text-sm">{{ notif.message }}</p>
        </div>
        <button (click)="notification.set(null)" class="ml-4 rounded-md p-1"
            [ngClass]="{'text-green-700 hover:bg-green-100': notif.type === 'success', 'text-red-700 hover:bg-red-100': notif.type === 'error'}">
            <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" />
            </svg>
        </button>
    </div>
</div>

<!-- Main Content -->
<div class="space-y-8 p-6">
    <!-- Header -->
    <div class="flex items-center justify-between">
        <div>
            <h1 class="text-2xl font-bold text-gray-800">Bookings</h1>
            <p class="text-sm text-gray-500">Manage vehicle reservations</p>
        </div>
        <button (click)="getAllBookings()" [disabled]="isLoading()"
            class="flex items-center gap-2 rounded-lg border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50 disabled:opacity-50">
            <svg class="h-4 w-4" [class.animate-spin]="isLoading()" fill="none" viewBox="0 0 24 24"
                stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
            </svg>
            Refresh
        </button>
    </div>

    <!-- Filter Section -->
    <div class="rounded-2xl bg-white shadow-lg">
        <h2 class="flex items-center gap-2 border-b border-gray-200 p-6 text-lg font-semibold text-gray-900">
            <svg class="h-5 w-5 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"
                stroke-linecap="round" stroke-linejoin="round">
                <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3" />
            </svg>
            Filter Bookings
        </h2>
        <div class="grid grid-cols-1 gap-4 p-6 md:grid-cols-2 lg:grid-cols-4">
            <div>
                <label for="filterCustomerName" class="block text-sm font-medium text-gray-700">Customer Name</label>
                <input type="text" id="filterCustomerName" [(ngModel)]="filter.customerName"
                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"
                    placeholder="Enter name..." />
            </div>
            <div>
                <label for="filterMobileNo" class="block text-sm font-medium text-gray-700">Mobile Number</label>
                <input type="text" id="filterMobileNo" [(ngModel)]="filter.mobileNo"
                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"
                    placeholder="Enter mobile..." />
            </div>
            <div>
                <label for="filterFromDate" class="block text-sm font-medium text-gray-700">From Date</label>
                <input type="date" id="filterFromDate" [(ngModel)]="filter.fromBookingDate"
                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" />
            </div>
            <div>
                <label for="filterToDate" class="block text-sm font-medium text-gray-700">To Date</label>
                <input type="date" id="filterToDate" [(ngModel)]="filter.toBookingDate"
                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" />
            </div>
        </div>
        <div class="flex items-center justify-end gap-3 bg-gray-50 px-6 py-4">
            <button (click)="resetFilter()"
                class="rounded-md bg-white px-3.5 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 transition-colors hover:bg-gray-50"
                [disabled]="isLoading()">
                Reset
            </button>
            <button (click)="applyFilter()"
                class="flex items-center justify-center rounded-md bg-blue-600 px-3.5 py-2 text-sm font-semibold text-white shadow-sm transition-colors hover:bg-blue-700"
                [disabled]="isLoading()">
                <svg *ngIf="isLoading()" class="-ml-1 mr-2 h-5 w-5 animate-spin" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor"
                        d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                    </path>
                </svg>
                Apply Filter
            </button>
        </div>
    </div>

    <!-- New Booking Form -->
    <div class="rounded-2xl bg-white shadow-lg">
        <h2 class="flex items-center gap-2 border-b border-gray-200 p-6 text-lg font-semibold text-gray-900">
            <svg class="h-5 w-5 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"
                stroke-linecap="round" stroke-linejoin="round">
                <path d="M5 12h14" />
                <path d="M12 5v14" />
            </svg>
            {{ activeBooking().bookingId === 0 ? 'Create New Booking' : 'Edit Booking' }}
        </h2>
        <form #bookingForm="ngForm" (ngSubmit)="handleFormSubmit(bookingForm)">
            <div class="grid grid-cols-1 gap-x-6 gap-y-4 p-6 lg:grid-cols-3">
                <!-- Customer Selection -->
                <div class="lg:col-span-1">
                    <label for="customer" class="block text-sm font-medium text-gray-700">Select Customer</label>
                    <select id="customer" [ngModel]="activeBooking().customerId"
                        (ngModelChange)="onCustomerSelect($event)" name="customerId"
                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"
                        required>
                        <option [ngValue]="0" disabled>Select a customer</option>
                        <option *ngFor="let customer of customerList()" [ngValue]="customer.customerId">
                            {{ customer.customerName }} ({{ customer.mobileNo }})
                        </option>
                    </select>
                </div>
                <!-- Customer Details (Readonly) -->
                <div class="rounded-md bg-gray-50 p-4 lg:col-span-2">
                    <dl class="grid grid-cols-2 gap-x-4 gap-y-2 sm:grid-cols-3">
                        <div class="sm:col-span-1">
                            <dt class="text-xs font-medium text-gray-500">Mobile</dt>
                            <dd class="text-sm text-gray-900">{{ selectedCustomer()?.mobileNo || 'N/A' }}</dd>
                        </div>
                        <div class="sm:col-span-1">
                            <dt class="text-xs font-medium text-gray-500">City</dt>
                            <dd class="text-sm text-gray-900">{{ selectedCustomer()?.city || 'N/A' }}</dd>
                        </div>
                        <div class="sm:col-span-1">
                            <dt class="text-xs font-medium text-gray-500">Email</dt>
                            <dd class="text-sm text-gray-900">{{ selectedCustomer()?.email || 'N/A' }}</dd>
                        </div>
                    </dl>
                </div>
                <!-- Vehicle Selection -->
                <div class="lg:col-span-1">
                    <label for="car" class="block text-sm font-medium text-gray-700">Select Vehicle</label>
                    <select id="car" [ngModel]="activeBooking().carId" (ngModelChange)="onCarSelect($event)"
                        name="carId"
                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"
                        required>
                        <option [ngValue]="0" disabled>Select a vehicle</option>
                        <option *ngFor="let car of carList()" [ngValue]="car.carId">
                            {{ car.brand }} {{ car.model }} ({{ car.regNo }})
                        </option>
                    </select>
                </div>
                <!-- Booking Details -->
                <div class="lg:col-span-2">
                    <div class="grid grid-cols-1 gap-4 sm:grid-cols-3">
                        <div>
                            <label for="bookingDate" class="block text-sm font-medium text-gray-700">Booking
                                Date</label>
                            <input type="date" id="bookingDate" [(ngModel)]="activeBooking().bookingDate"
                                name="bookingDate"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"
                                required />
                        </div>
                        <div>
                            <label for="discount" class="block text-sm font-medium text-gray-700">Discount (₹)</label>
                            <input type="number" id="discount" [(ngModel)]="activeBooking().discount" name="discount"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"
                                placeholder="0" />
                        </div>
                        <div>
                            <label for="totalBillAmount" class="block text-sm font-medium text-gray-700">Total Bill
                                (₹)</label>
                            <input type="number" id="totalBillAmount" [(ngModel)]="activeBooking().totalBillAmount"
                                name="totalBillAmount"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"
                                placeholder="0.00" required />
                        </div>
                    </div>
                </div>
            </div>
            <div class="flex items-center justify-end gap-3 bg-gray-50 px-6 py-4">
                <button type="button" (click)="resetForm(bookingForm)"
                    class="rounded-md bg-white px-3.5 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 transition-colors hover:bg-gray-50">
                    Reset
                </button>
                <button type="submit"
                    class="flex items-center justify-center rounded-md bg-blue-600 px-3.5 py-2 text-sm font-semibold text-white shadow-sm transition-colors hover:bg-blue-700"
                    [disabled]="isLoading() || bookingForm.invalid">
                    <svg *ngIf="isLoading()" class="-ml-1 mr-2 h-5 w-5 animate-spin" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4">
                        </circle>
                        <path class="opacity-75" fill="currentColor"
                            d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                        </path>
                    </svg>
                    {{ activeBooking().bookingId === 0 ? 'Create Booking' : 'Update Booking' }}
                </button>
            </div>
        </form>
    </div>

    <!-- Bookings List -->
    <div class="rounded-2xl bg-white shadow-lg">
        <h2 class="flex items-center gap-2 border-b border-gray-200 p-6 text-lg font-semibold text-gray-900">
            <svg class="h-5 w-5 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"
                stroke-linecap="round" stroke-linejoin="round">
                <path d="M4 2v20l2-1 2 1 2-1 2 1 2-1 2 1 2-1 2 1V2l-2 1-2-1-2 1-2-1-2 1-2-1-2 1Z" />
                <path d="M16 8h-6a2 2 0 1 0 0 4h6" />
                <path d="M12 12V8" />
            </svg>
            Bookings List
        </h2>
        <div class="relative overflow-x-auto">
            <!-- Loading Overlay -->
            <div *ngIf="isLoading()"
                class="absolute inset-0 z-10 flex items-center justify-center bg-white/70 backdrop-blur-sm">
                <svg class="h-8 w-8 animate-spin text-blue-600" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor"
                        d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                    </path>
                </svg>
            </div>
            <!-- Table -->
            <table class="min-w-full divide-y divide-gray-200" [class.opacity-50]="isLoading()">
                <thead class="bg-gray-50">
                    <tr>
                        <th scope="col"
                            class="px-6 py-3 text-left text-xs font-semibold uppercase tracking-wider text-gray-600">
                            Booking</th>
                        <th scope="col"
                            class="px-6 py-3 text-left text-xs font-semibold uppercase tracking-wider text-gray-600">
                            Customer</th>
                        <th scope="col"
                            class="px-6 py-3 text-left text-xs font-semibold uppercase tracking-wider text-gray-600">
                            Vehicle</th>
                        <th scope="col"
                            class="px-6 py-3 text-left text-xs font-semibold uppercase tracking-wider text-gray-600">
                            Amount</th>
                        <th scope="col"
                            class="px-6 py-3 text-right text-xs font-semibold uppercase tracking-wider text-gray-600">
                            Actions</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-200 bg-white">
                    <tr *ngIf="!isLoading() && bookingList().length === 0">
                        <td colspan="5" class="px-6 py-12 text-center text-sm text-gray-500">
                            No bookings found.
                        </td>
                    </tr>
                    <tr *ngFor="let booking of bookingList()" class="transition-colors hover:bg-gray-50"
                        [class.bg-yellow-50]="highlightBookingIds().includes(booking.bookingId)">
                        <td class="whitespace-nowrap px-6 py-4">
                            <div class="text-sm font-medium text-gray-900">ID: {{ booking.bookingId }}</div>
                            <div class="text-sm text-gray-500">{{ formatDate(booking.bookingDate) }}</div>
                        </td>
                        <td class="whitespace-nowrap px-6 py-4">
                            <div class="text-sm font-medium text-gray-900">{{ booking.customerName }}</div>
                            <div class="text-sm text-gray-500">{{ booking.bookingUid }}</div>
                        </td>
                        <td class="whitespace-nowrap px-6 py-4">
                            <div class="text-sm font-medium text-gray-900">{{ booking.brand }} {{ booking.model }}</div>
                            <div class="text-sm text-gray-500">Car ID: {{ booking.carId }}</div>
                        </td>
                        <td class="whitespace-nowrap px-6 py-4">
                            <div class="text-sm font-medium text-gray-900">{{ formatCurrency(booking.totalBillAmount) }}
                            </div>
                            <div *ngIf="booking.discount > 0" class="text-sm text-green-600">-{{
                                formatCurrency(booking.discount) }}</div>
                        </td>
                        <td class="whitespace-nowrap px-6 py-4 text-right text-sm font-medium">
                            <div class="flex items-center justify-end gap-2">
                                <button (click)="onEdit(booking)"
                                    class="rounded-md p-1.5 text-blue-600 transition-colors hover:bg-blue-100 hover:text-blue-800"
                                    title="Edit">
                                    <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                                        stroke-width="2">
                                        <path stroke-linecap="round" stroke-linejoin="round"
                                            d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                    </svg>
                                </button>
                                <button (click)="openDeleteModal(booking)"
                                    class="rounded-md p-1.5 text-red-600 transition-colors hover:bg-red-100 hover:text-red-800"
                                    title="Delete">
                                    <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                                        stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M3 6h18" />
                                        <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6" />
                                        <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2" />
                                    </svg>
                                </button>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div *ngIf="modal().visible" class="fixed inset-0 z-50 flex items-center justify-center">
    <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" (click)="closeModal()"></div>
    <div class="relative z-10 w-full max-w-md overflow-hidden rounded-2xl bg-white shadow-2xl">
        <div class="p-6">
            <div class="flex items-start gap-4">
                <div class="flex h-12 w-12 flex-shrink-0 items-center justify-center rounded-full bg-red-100">
                    <svg class="h-6 w-6 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                        stroke-width="1.5">
                        <path stroke-linecap="round" stroke-linejoin="round"
                            d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126ZM12 15.75h.007v.008H12v-.008Z" />
                    </svg>
                </div>
                <div class="min-w-0 flex-1">
                    <h3 class="text-lg font-semibold leading-6 text-gray-900">{{ modal().title }}</h3>
                    <div class="mt-2">
                        <p class="text-sm text-gray-600">{{ modal().message }}</p>
                    </div>
                </div>
            </div>
        </div>
        <div class="flex flex-row-reverse gap-3 bg-gray-50 px-6 py-4">
            <button type="button"
                class="rounded-md bg-red-600 px-3.5 py-2 text-sm font-semibold text-white shadow-sm transition-colors hover:bg-red-700"
                (click)="handleDeleteConfirm()" [disabled]="isLoading()">
                Delete
            </button>
            <button type="button"
                class="rounded-md bg-white px-3.5 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 transition-colors hover:bg-gray-50"
                (click)="closeModal()">
                Cancel
            </button>
        </div>
    </div>
</div>